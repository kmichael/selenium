package com.spoonium.grid.util

import net.liftweb.json._
import org.scalatest.{Matchers, FunSuite}

class SeleniumReponseBodyModifierTest extends FunSuite with Matchers {

  val sampleCommand =  """{"type":"SeleniumCommand","id":"/wd/hub/session/fcf8c3fb-806f-4b90-86e8-e47d22779dad/element","sessionId":"bdb3093f-7a17-47a5-9021-a74dc4523b70","method":"POST","requestBody":"{\"using\":\"css selector\",\"value\":\"span[data-field=\\\"description\\\"]\"}","responseBody":"{\"state\":\"no such element\",\"sessionId\":\"fcf8c3fb-806f-4b90-86e8-e47d22779dad\",\"hCode\":9315088,\"value\":{\"additionalInformation\":\"\\nDriver info: driver.version: unknown\",\"localizedMessage\":\"Unable to locate element: {\\\"method\\\":\\\"css selector\\\",\\\"selector\\\":\\\"span[data-field=\\\\\\\"description\\\\\\\"]\\\"}\\nFor documentation on this error, please visit: http://seleniumhq.org/exceptions/no_such_element.html\\nBuild info: version: '2.43.1', revision: '5163bce', time: '2014-09-10 16:27:33'\\nSystem info: host: 'edi-win', ip: '192.168.242.202', os.name: 'Windows 7', os.arch: 'x86', os.version: '6.1', java.version: '1.8.0_25'\\nDriver info: driver.version: unknown\",\"supportUrl\":\"http://seleniumhq.org/exceptions/no_such_element.html\",\"systemInformation\":\"System info: host: 'edi-win', ip: '192.168.242.202', os.name: 'Windows 7', os.arch: 'x86', os.version: '6.1', java.version: '1.8.0_25'\",\"cause\":null,\"screen\":\"iVBORw3g1zwAAAABJRU5ErkJggg==\",\"stackTrace\":[{\"fileName\":\"file:///C:/Users/IEUser/AppData/Local/Temp/anonymous8261809212746271902webdriver-profile/extensions/fxdriver@googlecode.com/components/driver-component.js:9618\",\"nativeMethod\":false,\"methodName\":\"FirefoxDriver.prototype.findElementInternal_\",\"className\":\"<anonymous class>\",\"hCode\":-2125666516,\"lineNumber\":26,\"class\":\"java.lang.StackTraceElement\"},{\"fileName\":\"file:///C:/Users/IEUser/AppData/Local/Temp/anonymous8261809212746271902webdriver-profile/extensions/fxdriver@googlecode.com/components/driver-component.js:9627\",\"nativeMethod\":false,\"methodName\":\"FirefoxDriver.prototype.findElement\",\"className\":\"<anonymous class>\",\"hCode\":1801885289,\"lineNumber\":3,\"class\":\"java.lang.StackTraceElement\"},{\"fileName\":\"file:///C:/Users/IEUser/AppData/Local/Temp/anonymous8261809212746271902webdriver-profile/extensions/fxdriver@googlecode.com/components/command-processor.js:11612\",\"nativeMethod\":false,\"methodName\":\"DelayedCommand.prototype.executeInternal_/h\",\"className\":\"<anonymous class>\",\"hCode\":1447568732,\"lineNumber\":16,\"class\":\"java.lang.StackTraceElement\"},{\"fileName\":\"file:///C:/Users/IEUser/AppData/Local/Temp/anonymous8261809212746271902webdriver-profile/extensions/fxdriver@googlecode.com/components/command-processor.js:11617\",\"nativeMethod\":false,\"methodName\":\"DelayedCommand.prototype.executeInternal_\",\"className\":\"<anonymous class>\",\"hCode\":-1538594411,\"lineNumber\":7,\"class\":\"java.lang.StackTraceElement\"},{\"fileName\":\"file:///C:/Users/IEUser/AppData/Local/Temp/anonymous8261809212746271902webdriver-profile/extensions/fxdriver@googlecode.com/components/command-processor.js:11559\",\"nativeMethod\":false,\"methodName\":\"DelayedCommand.prototype.execute/<\",\"className\":\"<anonymous class>\",\"hCode\":-1000393143,\"lineNumber\":5,\"class\":\"java.lang.StackTraceElement\"}],\"suppressed\":[],\"message\":\"Unable to locate element: {\\\"method\\\":\\\"css selector\\\",\\\"selector\\\":\\\"span[data-field=\\\\\\\"description\\\\\\\"]\\\"}\\nFor documentation on this error, please visit: http://seleniumhq.org/exceptions/no_such_element.html\\nBuild info: version: '2.43.1', revision: '5163bce', time: '2014-09-10 16:27:33'\\nSystem info: host: 'edi-win', ip: '192.168.242.202', os.name: 'Windows 7', os.arch: 'x86', os.version: '6.1', java.version: '1.8.0_25'\\nDriver info: driver.version: unknown\",\"hCode\":17266739,\"class\":\"org.openqa.selenium.NoSuchElementException\",\"buildInformation\":{\"buildRevision\":\"5163bce\",\"buildTime\":\"2014-09-10 16:27:33\",\"releaseLabel\":\"2.43.1\",\"hCode\":7121456,\"class\":\"org.openqa.selenium.internal.BuildInfo\"}},\"class\":\"org.openqa.selenium.remote.Response\",\"status\":7}","uri":"/element","duration":2540,"sessionRelativeDuration":14913,"browser":"firefox","version":"33"}"""
  val sampleResponseBody = toStringOpt(parse(sampleCommand) \ "responseBody").get

  test("modifying selenium response body to remove embedded base64 screenshot in case of failure") {
    // original response carries a base64 screenshot
    toStringOpt(parse(sampleResponseBody) \ "value" \ "screen") should be('defined)

    val transformed = new SeleniumResponseBodyModifier(sampleResponseBody).transformed()
    // transformed response doesn't have screenshot anymore
    toStringOpt(parse(transformed) \ "value" \ "screen") should be('empty)
  }

  def toStringOpt(json: JValue) = json match {
    case JString(v) => Some(v)
    case _ => None
  }
}
